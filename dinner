#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define MAX_DISH 100
#define MAX_TABLE 50
#define MAX_CUSTOMER 200
#define MAX_ORDER_ITEMS 50

typedef struct {
    int dishId;
    char name[50];
    char category[20];
    float price;
    char description[100];
} Dish;

typedef struct {
    int tableId;
    int capacity;
} Table;

typedef struct {
    int dishId;
    int quantity;
} OrderItem;

typedef struct {
    long long customerId;
    int tableId;
    char phone[12];
    char name[30];
    OrderItem orderList[MAX_ORDER_ITEMS];
    int orderCount;
    char datetime[20];
    int status;  // 1=就餐 2=打包
} Customer;

// 全局数据（简易版，实际可文件存储）
Dish dishes[MAX_DISH];
int dishCount = 0;

Table tables[MAX_TABLE];
int tableCount = 0;

Customer customers[MAX_CUSTOMER];
int customerCount = 0;

// 工具函数
long long generateCustomerId() {
    static long long id = 1000000000;
    return id++;
}

void getCurrentDateTime(char* buffer, int len) {
    time_t t = time(NULL);
    struct tm *tm_info = localtime(&t);
    strftime(buffer, len, "%Y-%m-%d %H:%M:%S", tm_info);
}

Dish* findDishById(int id) {
    for(int i=0; i<dishCount; i++) {
        if(dishes[i].dishId == id) return &dishes[i];
    }
    return NULL;
}

Table* findTableById(int id) {
    for(int i=0; i<tableCount; i++) {
        if(tables[i].tableId == id) return &tables[i];
    }
    return NULL;
}

Customer* findCustomer(int tableId, char* phone) {
    for(int i=0; i<customerCount; i++) {
        if(customers[i].tableId == tableId && strcmp(customers[i].phone, phone)==0) {
            return &customers[i];
        }
    }
    return NULL;
}

// ======= 菜品管理 =======
void addDish() {
    if(dishCount >= MAX_DISH) {
        printf("菜品数量已满，无法添加。\n");
        return;
    }
    Dish d;
    d.dishId = (dishCount == 0) ? 1001 : dishes[dishCount-1].dishId + 1;

    printf("请输入菜名: ");
    scanf(" %[^\n]", d.name);
    printf("请输入类别: ");
    scanf(" %[^\n]", d.category);
    printf("请输入价格: ");
    scanf("%f", &d.price);
    printf("请输入简介: ");
    scanf(" %[^\n]", d.description);

    dishes[dishCount++] = d;
    printf("添加成功！菜品编号是：%d\n", d.dishId);
}

void listDishes() {
    if(dishCount == 0) {
        printf("当前无菜品。\n");
        return;
    }
    printf("编号\t名称\t类别\t价格\t简介\n");
    for(int i=0; i<dishCount; i++) {
        printf("%d\t%s\t%s\t%.2f\t%s\n", dishes[i].dishId, dishes[i].name, dishes[i].category, dishes[i].price, dishes[i].description);
    }
}

void deleteDish() {
    printf("请输入要删除的菜品编号: ");
    int id; scanf("%d", &id);
    int idx = -1;
    for(int i=0; i<dishCount; i++) {
        if(dishes[i].dishId == id) { idx = i; break; }
    }
    if(idx == -1) {
        printf("未找到该菜品。\n");
        return;
    }
    for(int i=idx; i<dishCount-1; i++) {
        dishes[i] = dishes[i+1];
    }
    dishCount--;
    printf("删除成功。\n");
}

void modifyDish() {
    printf("请输入要修改的菜品编号: ");
    int id; scanf("%d", &id);
    Dish* d = findDishById(id);
    if(d == NULL) {
        printf("未找到该菜品。\n");
        return;
    }
    printf("修改菜名(当前:%s): ", d->name);
    scanf(" %[^\n]", d->name);
    printf("修改类别(当前:%s): ", d->category);
    scanf(" %[^\n]", d->category);
    printf("修改价格(当前:%.2f): ", d->price);
    scanf("%f", &d->price);
    printf("修改简介(当前:%s): ", d->description);
    scanf(" %[^\n]", d->description);
    printf("修改成功。\n");
}

// ======= 餐桌管理 =======
void addTable() {
    if(tableCount >= MAX_TABLE) {
        printf("餐桌数量已满。\n");
        return;
    }
    Table t;
    printf("请输入餐桌编号（三位整数，如101）: ");
    scanf("%d", &t.tableId);
    if(findTableById(t.tableId) != NULL) {
        printf("该餐桌编号已存在。\n");
        return;
    }
    printf("请输入可就餐人数: ");
    scanf("%d", &t.capacity);
    tables[tableCount++] = t;
    printf("添加成功。\n");
}

void listTables() {
    if(tableCount == 0) {
        printf("当前无餐桌信息。\n");
        return;
    }
    printf("餐桌编号\t可就餐人数\n");
    for(int i=0; i<tableCount; i++) {
        printf("%d\t\t%d\n", tables[i].tableId, tables[i].capacity);
    }
}

void deleteTable() {
    printf("请输入要删除的餐桌编号: ");
    int id; scanf("%d", &id);
    int idx = -1;
    for(int i=0; i<tableCount; i++) {
        if(tables[i].tableId == id) { idx = i; break; }
    }
    if(idx == -1) {
        printf("未找到该餐桌。\n");
        return;
    }
    for(int i=idx; i<tableCount-1; i++) {
        tables[i] = tables[i+1];
    }
    tableCount--;
    printf("删除成功。\n");
}

void modifyTable() {
    printf("请输入要修改的餐桌编号: ");
    int id; scanf("%d", &id);
    Table* t = findTableById(id);
    if(t == NULL) {
        printf("未找到该餐桌。\n");
        return;
    }
    printf("修改可就餐人数(当前:%d): ", t->capacity);
    scanf("%d", &t->capacity);
    printf("修改成功。\n");
}

// ======= 用餐者登录 =======
Customer* userRegister() {
    printf("请输入桌号（三位整数）: ");
    int tableId; scanf("%d", &tableId);
    if(findTableById(tableId) == NULL) {
        printf("餐桌不存在，请联系管理员添加。\n");
        return NULL;
    }
    char phone[12], name[30];
    printf("请输入电话号码（11位）: ");
    scanf("%s", phone);
    if(strlen(phone) != 11) {
        printf("电话号码格式错误。\n");
        return NULL;
    }
    printf("请输入姓名: ");
    scanf(" %[^\n]", name);

    Customer* existing = findCustomer(tableId, phone);
    if(existing != NULL) {
        printf("欢迎回来，%s！\n", existing->name);
        return existing;
    }

    if(customerCount >= MAX_CUSTOMER) {
        printf("用餐者数量已满，无法注册。\n");
        return NULL;
    }

    Customer c;
    c.customerId = generateCustomerId();
    c.tableId = tableId;
    strcpy(c.phone, phone);
    strcpy(c.name, name);
    c.orderCount = 0;
    getCurrentDateTime(c.datetime, sizeof(c.datetime));
    c.status = 1;

    customers[customerCount++] = c;
    printf("注册成功！您的编号是%lld\n", c.customerId);
    return &customers[customerCount-1];
}

// ======= 用餐者点餐 =======
void userOrder(Customer *cust) {
    while(1) {
        listDishes();
        printf("请输入要点的菜品编号（0退出点餐）: ");
        int dishId; scanf("%d", &dishId);
        if(dishId == 0) break;

        Dish* d = findDishById(dishId);
        if(d == NULL) {
            printf("无效的菜品编号。\n");
            continue;
        }
        printf("请输入数量: ");
        int qty; scanf("%d", &qty);
        if(qty <= 0) {
            printf("数量必须大于0。\n");
            continue;
        }
        // 检查是否已点过该菜
        int found = 0;
        for(int i=0; i<cust->orderCount; i++) {
            if(cust->orderList[i].dishId == dishId) {
                cust->orderList[i].quantity += qty;
                found = 1;
                break;
            }
        }
        if(!found) {
            if(cust->orderCount >= MAX_ORDER_ITEMS) {
                printf("订单已满，无法再点更多菜品。\n");
                break;
            }
            cust->orderList[cust->orderCount].dishId = dishId;
            cust->orderList[cust->orderCount].quantity = qty;
            cust->orderCount++;
        }
        printf("点餐成功！\n");
    }
}

// 显示用餐者订单详情
void showCustomerOrder(Customer *cust) {
    printf("订单详情：\n");
    printf("菜名\t单价\t数量\t小计\n");
    float total = 0.0;
    for(int i=0; i<cust->orderCount; i++) {
        Dish* d = findDishById(cust->orderList[i].dishId);
        if(d) {
            float sub = d->price * cust->orderList[i].quantity;
            printf("%s\t%.2f\t%d\t%.2f\n", d->name, d->price, cust->orderList[i].quantity, sub);
            total += sub;
        }
    }
    printf("总计金额：%.2f\n", total);
}

// 用餐者结账
void userPay(Customer *cust) {
    showCustomerOrder(cust);
    printf("确认结账吗？（y/n）: ");
    char ch; scanf(" %c", &ch);
    if(ch == 'y' || ch == 'Y') {
        cust->status = 0;  // 标记已结账
        printf("结账成功！欢迎下次光临。\n");
    } else {
        printf("取消结账。\n");
    }
}

// ========== 管理员菜单 ===========
void adminMenu() {
    while(1) {
        printf("\n--- 管理员菜单 ---\n");
        printf("1. 菜品管理\n");
        printf("2. 餐桌管理\n");
        printf("3. 退出\n");
        printf("请选择: ");
        int choice; scanf("%d", &choice);
        if(choice == 1) {
            while(1) {
                printf("\n-- 菜品管理 --\n");
                printf("1. 添加菜品\n");
                printf("2. 查看菜品\n");
                printf("3. 删除菜品\n");
                printf("4. 修改菜品\n");
                printf("5. 返回\n");
                printf("请选择: ");
                int c; scanf("%d", &c);
                if(c == 1) addDish();
                else if(c == 2) listDishes();
                else if(c == 3) deleteDish();
                else if(c == 4) modifyDish();
                else if(c == 5) break;
                else printf("无效选项\n");
            }
        } else if(choice == 2) {
            while(1) {
                printf("\n-- 餐桌管理 --\n");
                printf("1. 添加餐桌\n");
                printf("2. 查看餐桌\n");
                printf("3. 删除餐桌\n");
                printf("4. 修改餐桌\n");
                printf("5. 返回\n");
                printf("请选择: ");
                int c; scanf("%d", &c);
                if(c == 1) addTable();
                else if(c == 2) listTables();
                else if(c == 3) deleteTable();
                else if(c == 4) modifyTable();
                else if(c == 5) break;
                else printf("无效选项\n");
            }
        } else if(choice == 3) {
            printf("退出管理员模式。\n");
            break;
        } else {
            printf("无效选项\n");
        }
    }
}

// ========== 用餐者菜单 ===========
void userMenu() {
    Customer* cust = userRegister();
    if(cust == NULL) return;

    while(1) {
        printf("\n--- 用餐者菜单 ---\n");
        printf("1. 浏览菜单\n");
        printf("2. 点餐\n");
        printf("3. 查看订单\n");
        printf("4. 结账\n");
        printf("5. 退出\n");
        printf("请选择: ");
        int choice; scanf("%d", &choice);
        if(choice == 1) {
            listDishes();
        } else if(choice == 2) {
            userOrder(cust);
        } else if(choice == 3) {
            showCustomerOrder(cust);
        } else if(choice == 4) {
            userPay(cust);
        } else if(choice == 5) {
            printf("退出用餐者模式。\n");
            break;
        } else {
            printf("无效选项\n");
        }
    }
}

int main(int argc, char *argv[]) {
    if(argc < 2) {
        printf("用法: %s -admin|-user\n", argv[0]);
        return 1;
    }

    if(strcmp(argv[1], "-admin") == 0) {
        printf("欢迎进入管理员模式。\n");
        adminMenu();
    } else if(strcmp(argv[1], "-user") == 0) {
        printf("欢迎进入用餐者模式。\n");
        userMenu();
    } else {
        printf("参数错误，请使用 -admin 或 -user\n");
        return 1;
    }
    return 0;
}

